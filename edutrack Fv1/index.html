<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>EduTrack - Sistema Educativo Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        :root {
            --bg: #0f172a;
            --card: #101b37;
            --muted: #9db1d3;
            --text: #e6eefc;
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --shadow: 0 6px 18px rgba(0,0,0,.3);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, Arial, sans-serif;
            background: linear-gradient(135deg, #0b1226 0%, #1e293b 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-content {
            width: 100%;
            max-width: 400px;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 8px;
        }

        .logo p {
            color: var(--muted);
            font-size: 1rem;
        }

        .login-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,.1);
        }

        .role-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .role-btn {
            background: rgba(255,255,255,.08);
            border: 2px solid transparent;
            border-radius: var(--radius);
            padding: 12px 8px;
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .role-btn:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .role-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }

        .role-btn i {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 6px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .input-group {
            position: relative;
        }

        .input-group i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
        }

        .form-control {
            width: 100%;
            padding: 14px 14px 14px 40px;
            border: 2px solid rgba(255,255,255,.1);
            border-radius: var(--radius);
            background: rgba(255,255,255,.05);
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255,255,255,.08);
        }

        .btn {
            padding: 14px;
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .btn-block {
            width: 100%;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-secondary {
            background: rgba(255,255,255,.1);
            color: var(--text);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-danger {
            background: var(--danger);
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(13, 19, 41, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .navigation {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255,255,255,.08);
            border: none;
            border-radius: var(--radius);
            padding: 12px 20px;
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .panel.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,.1);
            transition: var(--transition);
        }

        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0,0,0,.4);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .card-header i {
            font-size: 1.8rem;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
        }

        .card-content {
            color: var(--muted);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .stats-panel {
            background: rgba(13, 19, 41, 0.8);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: var(--radius);
            background: rgba(255,255,255,.05);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,.08);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .students-evaluation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .student-evaluation-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,.1);
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .student-evaluation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0,0,0,.4);
        }

        .student-evaluation-card.presente { border-left-color: var(--success); }
        .student-evaluation-card.tarde { border-left-color: var(--warning); }
        .student-evaluation-card.falta { border-left-color: var(--danger); }

        .student-header {
            border-bottom: 2px solid rgba(255,255,255,.1);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .student-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .student-info {
            color: var(--muted);
            font-size: 0.9rem;
            display: flex;
            gap: 15px;
        }

        .evaluation-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255,255,255,.05);
            border-radius: 8px;
            transition: var(--transition);
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: rgba(255,255,255,.1);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            font-size: 0.9rem;
        }

        .status-presente { color: var(--success); }
        .status-tarde { color: var(--warning); }
        .status-falta { color: var(--danger); }
        .status-alto { color: var(--success); }
        .status-medio { color: var(--warning); }
        .status-bajo { color: var(--danger); }
        .status-bien { color: var(--success); }
        .status-regular { color: var(--warning); }
        .status-deficiente { color: var(--danger); }

        .notes-section {
            margin-top: 15px;
        }

        .notes-textarea {
            width: 100%;
            background: rgba(255,255,255,.05);
            border: 2px solid rgba(255,255,255,.1);
            border-radius: var(--radius);
            padding: 12px;
            color: var(--text);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 70px;
            transition: var(--transition);
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255,255,255,.08);
        }

        .student-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-sm {
            padding: 10px 15px;
            font-size: 0.85rem;
        }

        .codes-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .code-item {
            background: rgba(255,255,255,.05);
            padding: 15px;
            border-radius: var(--radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .code-info {
            flex: 1;
        }

        .code-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: 2px;
        }

        .code-student {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .code-actions {
            display: flex;
            gap: 8px;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            background: var(--primary);
            color: #fff;
            padding: 16px 24px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,.4);
            opacity: 0;
            z-index: 1000;
            animation: fadeInOut 2.5s ease forwards;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            width: 90%;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(30px); }
            15%, 85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(30px); }
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--card);
            padding: 8px 12px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 3px solid var(--success);
            box-shadow: var(--shadow);
        }

        .sync-status.connected { border-left-color: var(--success); }
        .sync-status.disconnected { border-left-color: var(--danger); }
        .sync-status.syncing { border-left-color: var(--warning); }

        .offline-indicator {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }

        .backup-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .role-selector {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            .students-evaluation-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
            .sync-status {
                top: 5px;
                right: 5px;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Indicadores de Estado -->
    <div class="sync-status connected" id="syncStatus">
        <i class="fas fa-cloud"></i>
        <span>Conectado</span>
    </div>
    
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i>
        <span>Modo sin conexión</span>
    </div>

    <!-- Pantalla de Login -->
    <div class="screen active" id="loginScreen">
        <div class="login-container">
            <div class="login-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <h1>EduTrack</h1>
                    <p>Sistema Integral de Evaluación</p>
                </div>

                <div class="login-card">
                    <div class="role-selector">
                        <button class="role-btn active" data-role="admin">
                            <i class="fas fa-user-shield"></i>
                            Prof. Administrador
                        </button>
                        <button class="role-btn" data-role="teacher">
                            <i class="fas fa-chalkboard-teacher"></i>
                            Maestro
                        </button>
                        <button class="role-btn" data-role="parent">
                            <i class="fas fa-user-friends"></i>
                            Padre/Madre
                        </button>
                    </div>

                    <div id="adminLogin">
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="username">Usuario Administrador</label>
                                <div class="input-group">
                                    <i class="fas fa-user-shield"></i>
                                    <input type="text" id="username" class="form-control" placeholder="admin" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="password">Contraseña</label>
                                <div class="input-group">
                                    <i class="fas fa-lock"></i>
                                    <input type="password" id="password" class="form-control" placeholder="admin123" required>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-sign-in-alt"></i>
                                Iniciar Sesión
                            </button>
                        </form>
                    </div>

                    <div id="teacherLogin" class="hidden">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; color: var(--warning); margin-bottom: 16px;">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <h3 style="color: var(--warning); margin-bottom: 8px;">Acceso para Maestros</h3>
                            <p style="color: var(--muted); margin-bottom: 20px; font-size: 0.9rem;">
                                Selecciona tu materia para acceder al sistema
                            </p>
                            
                            <div class="form-group">
                                <label for="teacherSubject">Materia</label>
                                <select id="teacherSubject" class="form-control">
                                    <option value="">Selecciona tu materia</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="teacherPassword">Contraseña de la Materia</label>
                                <div class="input-group">
                                    <i class="fas fa-lock"></i>
                                    <input type="password" id="teacherPassword" class="form-control" placeholder="Contraseña de la materia" required>
                                </div>
                            </div>

                            <button class="btn btn-warning btn-block" onclick="teacherLogin()">
                                <i class="fas fa-sign-in-alt"></i>
                                Acceder a la Materia
                            </button>
                        </div>
                    </div>

                    <div id="parentLogin" class="hidden">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; color: var(--secondary); margin-bottom: 16px;">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <h3 style="color: var(--secondary); margin-bottom: 8px;">Acceso para Padres</h3>
                            <p style="color: var(--muted); margin-bottom: 20px; font-size: 0.9rem;">
                                Ingresa el código familiar para ver el progreso de tu hijo
                            </p>
                            
                            <div class="form-group">
                                <label for="parentCodeInput">
                                    <i class="fas fa-key"></i>
                                    Código Familiar
                                </label>
                                <input type="text" id="parentCodeInput" class="form-control" 
                                       placeholder="ABCDEF" maxlength="6"
                                       style="text-align: center; font-size: 1.2rem; letter-spacing: 2px;">
                            </div>

                            <button class="btn btn-primary btn-block" onclick="parentLogin()">
                                <i class="fas fa-eye"></i>
                                Ver Progreso
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard del Profesor Administrador -->
    <div class="screen" id="adminScreen">
        <div class="app">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">PA</div>
                    <div>
                        <h3 style="color: var(--text); margin-bottom: 4px;" id="adminName">Profesor Administrador</h3>
                        <p style="color: var(--muted); font-size: 0.9rem;" id="currentDateDisplay"></p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="EduTrackSync.exportData()">
                        <i class="fas fa-download"></i>
                        Exportar
                    </button>
                    <button class="btn btn-success" onclick="EduTrackSync.syncFromFirestore()">
                        <i class="fas fa-sync"></i>
                        Sincronizar
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Salir
                    </button>
                </div>
            </div>

            <div class="navigation">
                <button class="nav-btn active" data-panel="adminDashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </button>
                <button class="nav-btn" data-panel="studentsPanel">
                    <i class="fas fa-user-graduate"></i>
                    Estudiantes
                </button>
                <button class="nav-btn" data-panel="teachersPanel">
                    <i class="fas fa-chalkboard-teacher"></i>
                    Maestros
                </button>
                <button class="nav-btn" data-panel="codesPanel">
                    <i class="fas fa-qrcode"></i>
                    Códigos
                </button>
                <button class="nav-btn" data-panel="backupPanel">
                    <i class="fas fa-database"></i>
                    Backup
                </button>
            </div>

            <div class="panel active" id="adminDashboard">
                <div class="stats-panel">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalStudents">16</div>
                            <div class="stat-label">Total Estudiantes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalSubjects">10</div>
                            <div class="stat-label">Materias</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statActiveCodes">0</div>
                            <div class="stat-label">Códigos Activos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statOverallAttendance">0%</div>
                            <div class="stat-label">Asistencia General</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-user-graduate" style="color: var(--info);"></i>
                            <div class="card-title">Gestión de Estudiantes</div>
                        </div>
                        <div class="card-content">
                            Agrega, edita y gestiona la lista de estudiantes del Grupo A
                        </div>
                        <button class="btn btn-info btn-block" onclick="showPanel('studentsPanel')">
                            <i class="fas fa-users"></i>
                            Gestionar Estudiantes
                        </button>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-chalkboard-teacher" style="color: var(--warning);"></i>
                            <div class="card-title">Gestión de Maestros</div>
                        </div>
                        <div class="card-content">
                            Administra los maestros y sus materias asignadas
                        </div>
                        <button class="btn btn-warning btn-block" onclick="showPanel('teachersPanel')">
                            <i class="fas fa-users-cog"></i>
                            Gestionar Maestros
                        </button>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-qrcode" style="color: var(--secondary);"></i>
                            <div class="card-title">Códigos Familiares</div>
                        </div>
                        <div class="card-content">
                            Genera y gestiona códigos únicos por familia
                        </div>
                        <button class="btn btn-secondary btn-block" onclick="showPanel('codesPanel')">
                            <i class="fas fa-key"></i>
                            Gestionar Códigos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel de Gestión de Estudiantes -->
            <div class="panel" id="studentsPanel">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-user-plus" style="color: var(--success);"></i>
                        <div class="card-title">Agregar Nuevo Estudiante</div>
                    </div>
                    <div class="card-content">
                        <form id="addStudentForm">
                            <div class="form-group">
                                <label for="newStudentName">Nombre Completo del Estudiante</label>
                                <input type="text" id="newStudentName" class="form-control" 
                                       placeholder="Ej: González Pérez María" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="newStudentEmail">Email (opcional)</label>
                                <input type="email" id="newStudentEmail" class="form-control" 
                                       placeholder="ejemplo@correo.com">
                            </div>

                            <div class="form-group">
                                <label for="newStudentPhone">Teléfono Contacto (opcional)</label>
                                <input type="tel" id="newStudentPhone" class="form-control" 
                                       placeholder="+52 123 456 7890">
                            </div>

                            <button type="submit" class="btn btn-success btn-block">
                                <i class="fas fa-save"></i>
                                Agregar al Grupo A
                            </button>
                        </form>
                    </div>
                </div>

                <div class="dashboard-card" style="margin-top: 20px;">
                    <div class="card-header">
                        <i class="fas fa-list" style="color: var(--primary);"></i>
                        <div class="card-title">Lista de Estudiantes - Grupo A</div>
                    </div>
                    <div class="card-content">
                        <p style="margin-bottom: 15px; color: var(--muted);">
                            Total de estudiantes: <strong id="studentsCount">0</strong>
                        </p>
                        <div id="studentsListContainer">
                            <!-- Lista de estudiantes se cargará aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel" id="teachersPanel">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-chalkboard-teacher" style="color: var(--info);"></i>
                        <div class="card-title">Gestión de Maestros y Materias</div>
                    </div>
                    <div class="card-content">
                        <p style="margin-bottom: 20px; color: var(--muted);">
                            Asigna y gestiona los maestros responsables de cada materia.
                        </p>
                        
                        <div class="codes-grid" id="teachersList">
                            <!-- Lista de maestros y materias se cargará aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel" id="codesPanel">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-plus-circle" style="color: var(--success);"></i>
                            <div class="card-title">Generar Código Familiar</div>
                        </div>
                        <div class="card-content">
                            <p style="margin-bottom: 15px; color: var(--muted);">
                                Genera un código único para una familia. Este código dará acceso a TODAS las materias del estudiante.
                            </p>
                            
                            <div class="form-group">
                                <label for="familyStudentSelect">Estudiante</label>
                                <select id="familyStudentSelect" class="form-control">
                                    <option value="">Selecciona un estudiante</option>
                                </select>
                            </div>

                            <button class="btn btn-success btn-block" onclick="generateFamilyCode()">
                                <i class="fas fa-key"></i>
                                Generar Código Familiar
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-list" style="color: var(--primary);"></i>
                            <div class="card-title">Códigos Familiares Activos</div>
                        </div>
                        <div class="card-content">
                            <p style="margin-bottom: 15px; color: var(--muted);">
                                Lista de todos los códigos familiares activos.
                            </p>
                            
                            <div class="codes-grid" id="familyCodesList">
                                <!-- Códigos familiares se cargará aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NUEVO PANEL: Backup y Restore -->
            <div class="panel" id="backupPanel">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-download" style="color: var(--success);"></i>
                            <div class="card-title">Exportar Datos</div>
                        </div>
                        <div class="card-content">
                            <p>Descarga una copia de seguridad de todos los datos del sistema.</p>
                            <div class="backup-actions">
                                <button class="btn btn-success" onclick="EduTrackSync.exportData()">
                                    <i class="fas fa-file-export"></i>
                                    Exportar Todo
                                </button>
                                <button class="btn btn-info" onclick="EduTrackSync.exportStudents()">
                                    <i class="fas fa-user-graduate"></i>
                                    Solo Estudiantes
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-upload" style="color: var(--warning);"></i>
                            <div class="card-title">Importar Datos</div>
                        </div>
                        <div class="card-content">
                            <p>Restaura datos desde un archivo de respaldo.</p>
                            <div class="form-group">
                                <label for="backupFile">Seleccionar archivo de respaldo</label>
                                <input type="file" id="backupFile" class="form-control" accept=".json">
                            </div>
                            <button class="btn btn-warning btn-block" onclick="EduTrackSync.importData()">
                                <i class="fas fa-file-import"></i>
                                Importar Datos
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-cloud" style="color: var(--info);"></i>
                            <div class="card-title">Sincronización en la Nube</div>
                        </div>
                        <div class="card-content">
                            <p>Estado de la sincronización con Firebase.</p>
                            <div style="margin: 15px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Estudiantes:</span>
                                    <span id="syncStudents">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Evaluaciones:</span>
                                    <span id="syncEvaluations">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Códigos:</span>
                                    <span id="syncCodes">0</span>
                                </div>
                            </div>
                            <button class="btn btn-info btn-block" onclick="EduTrackSync.syncFromFirestore()">
                                <i class="fas fa-sync"></i>
                                Forzar Sincronización
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard del Maestro -->
    <div class="screen" id="teacherScreen">
        <div class="app">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" style="background: var(--warning);">M</div>
                    <div>
                        <h3 style="color: var(--text); margin-bottom: 4px;" id="teacherSubjectName">Materia - Maestro</h3>
                        <p style="color: var(--muted); font-size: 0.9rem;">Sistema de Evaluación por Materia</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="showScreen('loginScreen')">
                        <i class="fas fa-arrow-left"></i>
                        Cambiar Materia
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Salir
                    </button>
                </div>
            </div>

            <div class="navigation">
                <button class="nav-btn active" data-panel="teacherDashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </button>
                <button class="nav-btn" data-panel="evaluationPanel">
                    <i class="fas fa-clipboard-check"></i>
                    Evaluación Individual
                </button>
                <button class="nav-btn" data-panel="reportsPanel">
                    <i class="fas fa-chart-bar"></i>
                    Reportes
                </button>
            </div>

            <div class="panel active" id="teacherDashboard">
                <div class="stats-panel">
                    <h3 style="color: var(--warning); margin-bottom: 15px;">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span id="currentSubjectName">Materia</span> - Dashboard del Maestro
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="teacherStatTotal">16</div>
                            <div class="stat-label">Estudiantes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="teacherStatPresent">0</div>
                            <div class="stat-label">Presentes Hoy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="teacherStatAttendance">0%</div>
                            <div class="stat-label">Asistencia</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-clipboard-check" style="color: var(--success);"></i>
                            <div class="card-title">Evaluación Individual</div>
                        </div>
                        <div class="card-content">
                            Evalúa a cada estudiante individualmente con el nuevo sistema de tarjetas
                        </div>
                        <button class="btn btn-success btn-block" onclick="showPanel('evaluationPanel')">
                            <i class="fas fa-play"></i>
                            Comenzar Evaluación
                        </button>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar" style="color: var(--info);"></i>
                            <div class="card-title">Reportes de la Materia</div>
                        </div>
                        <div class="card-content">
                            Consulta reportes detallados del desempeño en tu materia
                        </div>
                        <button class="btn btn-info btn-block" onclick="showPanel('reportsPanel')">
                            <i class="fas fa-chart-pie"></i>
                            Ver Reportes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel: Evaluación Individual por Tarjetas -->
            <div class="panel" id="evaluationPanel">
                <div class="stats-panel">
                    <h3 style="color: var(--warning); margin-bottom: 15px;">
                        <i class="fas fa-clipboard-check"></i>
                        Evaluación Individual - <span id="evaluationSubjectName">Materia</span>
                    </h3>
                    <p style="color: var(--muted);">
                        Evalúa a cada estudiante individualmente. Los cambios se guardan automáticamente.
                    </p>
                </div>

                <div class="actions" style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="guardarTodasEvaluaciones()">
                        <i class="fas fa-save"></i>
                        Guardar Todas las Evaluaciones
                    </button>
                    <button class="btn btn-secondary" onclick="limpiarTodasEvaluaciones()">
                        <i class="fas fa-broom"></i>
                        Limpiar Todo
                    </button>
                </div>

                <div class="students-evaluation-grid" id="teacherEvaluationContainer">
                    <!-- Las tarjetas de evaluación individual se cargarán aquí -->
                </div>
            </div>

            <div class="panel" id="reportsPanel">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar" style="color: var(--info);"></i>
                        <div class="card-title">Reportes de <span id="reportsSubjectName">Materia</span></div>
                    </div>
                    <div class="card-content">
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <div class="stat-value" id="reportEvaluations">0</div>
                                <div class="stat-label">Evaluaciones Hoy</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="reportAttendance">0%</div>
                                <div class="stat-label">Asistencia</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="reportPerformance">0%</div>
                                <div class="stat-label">Rendimiento</div>
                            </div>
                        </div>

                        <div id="reportsContent">
                            <!-- Contenido de reportes se cargará aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vista para Padres -->
    <div class="screen" id="parentScreen">
        <div class="app">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" style="background: var(--secondary);">F</div>
                    <div>
                        <h3 style="color: var(--text); margin-bottom: 4px;" id="parentStudentName">Vista Familiar</h3>
                        <p style="color: var(--muted); font-size: 0.9rem;">Progreso Integral del Estudiante</p>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Salir
                </button>
            </div>

            <div class="dashboard-card">
                <div id="familyProgress">
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Ingresa con tu código familiar para ver el progreso</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración del sistema
        const EduTrack = {
            config: {
                admin: { 
                    username: 'admin', 
                    password: 'admin123', 
                    name: 'Profesor Administrador',
                    role: 'admin' 
                },
                subjects: [
                    { 
                        id: 'math', 
                        name: 'Matemáticas', 
                        password: 'math123', 
                        color: '#ef4444',
                        teacher: 'Prof. Carlos Rodríguez'
                    },
                    { 
                        id: 'spanish', 
                        name: 'Español', 
                        password: 'spanish123', 
                        color: '#3b82f6',
                        teacher: 'Prof. Ana Martínez'
                    },
                    { 
                        id: 'science', 
                        name: 'Ciencias', 
                        password: 'science123', 
                        color: '#22c55e',
                        teacher: 'Prof. Laura Hernández'
                    },
                    { 
                        id: 'history', 
                        name: 'Historia', 
                        password: 'history123', 
                        color: '#f59e0b',
                        teacher: 'Prof. Miguel Sánchez'
                    },
                    { 
                        id: 'geography', 
                        name: 'Geografía', 
                        password: 'geo123', 
                        color: '#8b5cf6',
                        teacher: 'Prof. Elena Castro'
                    },
                    { 
                        id: 'english', 
                        name: 'Inglés', 
                        password: 'english123', 
                        color: '#06b6d4',
                        teacher: 'Prof. David Wilson'
                    },
                    { 
                        id: 'art', 
                        name: 'Artes', 
                        password: 'art123', 
                        color: '#ec4899',
                        teacher: 'Prof. Sofia Ramírez'
                    },
                    { 
                        id: 'pe', 
                        name: 'Educación Física', 
                        password: 'pe123', 
                        color: '#84cc16',
                        teacher: 'Prof. Roberto Torres'
                    },
                    { 
                        id: 'music', 
                        name: 'Música', 
                        password: 'music123', 
                        color: '#f97316',
                        teacher: 'Prof. Carmen López'
                    },
                    { 
                        id: 'computers', 
                        name: 'Computación', 
                        password: 'comp123', 
                        color: '#6366f1',
                        teacher: 'Prof. Jorge Morales'
                    }
                ],
                students: [
                    { id: 1, name: "Blanco López Sofía Guadalupe", grupo: "A", email: "", phone: "" },
                    { id: 2, name: "Domínguez Alba Regina", grupo: "A", email: "", phone: "" },
                    { id: 3, name: "Escobar Hernández Sergio Emilio", grupo: "A", email: "", phone: "" },
                    { id: 4, name: "Escobar Nuricumbo Sofía Itzel", grupo: "A", email: "", phone: "" },
                    { id: 5, name: "Greene Ruiz Alberto", grupo: "A", email: "", phone: "" },
                    { id: 6, name: "Greene Ruiz Alexander", grupo: "A", email: "", phone: "" },
                    { id: 7, name: "Hernández Torres Manuel de Jesús", grupo: "A", email: "", phone: "" },
                    { id: 8, name: "Jiménez Cruz Rodrigo Sebastián", grupo: "A", email: "", phone: "" },
                    { id: 9, name: "Maza Martínez Renata", grupo: "A", email: "", phone: "" },
                    { id: 10, name: "Ortiz Murillo Sofía Melissa", grupo: "A", email: "", phone: "" },
                    { id: 11, name: "Pérez Aguilar Adrián Magín", grupo: "A", email: "", phone: "" },
                    { id: 12, name: "Pérez de los Santos Valentina Guadalupe", grupo: "A", email: "", phone: "" },
                    { id: 13, name: "Ramos Arévalo Génesis Janeth", grupo: "A", email: "", phone: "" },
                    { id: 14, name: "Rojas Bascós Ana Victoria", grupo: "A", email: "", phone: "" },
                    { id: 15, name: "Gómez Vázquez Ángel", grupo: "A", email: "", phone: "" },
                    { id: 16, name: "Rodríguez Espinoza Frida", grupo: "A", email: "", phone: "" }
                ]
            },

            data: {
                currentUser: null,
                currentSubject: null,
                currentDate: new Date(),
                familyCodes: {},
                evaluationData: {},
                currentRole: 'admin',
                currentFamilyCode: null
            },

            init() {
                this.loadSavedData();
                this.setupEventListeners();
                this.updateDateDisplay();
                this.loadTeacherSubjects();
                this.showLoginForm();
                this.updateAdminStats();
                this.renderStudentsList();
                this.loadFamilyStudentSelect();
                this.renderFamilyCodes();
                this.renderTeachersList();
                
                console.log("✓ EduTrack inicializado correctamente");
            },

            loadSavedData() {
                try {
                    const savedCodes = localStorage.getItem('edutrack_family_codes');
                    const savedEval = localStorage.getItem('edutrack_evaluation_data');
                    const savedStudents = localStorage.getItem('edutrack_students');
                    
                    if (savedCodes) this.data.familyCodes = JSON.parse(savedCodes);
                    if (savedEval) this.data.evaluationData = JSON.parse(savedEval);
                    if (savedStudents) this.config.students = JSON.parse(savedStudents);
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            },

            saveStudents() {
                localStorage.setItem('edutrack_students', JSON.stringify(this.config.students));
            },

            saveFamilyCodes() {
                localStorage.setItem('edutrack_family_codes', JSON.stringify(this.data.familyCodes));
            },

            saveEvaluationData() {
                localStorage.setItem('edutrack_evaluation_data', JSON.stringify(this.data.evaluationData));
            },

            getEvaluationKey(subjectId, studentId, date = this.data.currentDate) {
                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                return `${subjectId}_${studentId}_${dateKey}`;
            },

            setupEventListeners() {
                document.querySelectorAll('.role-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.data.currentRole = btn.dataset.role;
                        this.showLoginForm();
                    });
                });

                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAdminLogin();
                });

                document.getElementById('addStudentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addNewStudent();
                });

                document.getElementById('parentCodeInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.parentLogin();
                });

                document.getElementById('teacherPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.teacherLogin();
                });

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const panelId = btn.dataset.panel;
                        this.showPanel(panelId);
                    });
                });
            },

            addNewStudent() {
                const name = document.getElementById('newStudentName').value.trim();
                const email = document.getElementById('newStudentEmail').value.trim();
                const phone = document.getElementById('newStudentPhone').value.trim();

                if (!name) {
                    this.showToast('El nombre es obligatorio', 'warning');
                    return;
                }

                const newId = this.config.students.length > 0 
                    ? Math.max(...this.config.students.map(s => s.id)) + 1 
                    : 1;

                const newStudent = {
                    id: newId,
                    name: name,
                    grupo: "A",
                    email: email,
                    phone: phone
                };

                this.config.students.push(newStudent);
                this.saveStudents();
                
                this.showToast(`Estudiante ${name} agregado al Grupo A`, 'success');
                
                document.getElementById('addStudentForm').reset();
                
                this.renderStudentsList();
                this.loadFamilyStudentSelect();
                this.updateAdminStats();
            },

            renderStudentsList() {
                const container = document.getElementById('studentsListContainer');
                const countElement = document.getElementById('studentsCount');
                
                if (!container) return;

                if (this.config.students.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--muted);">
                            <i class="fas fa-user-graduate" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>No hay estudiantes registrados en el Grupo A</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                this.config.students.forEach(student => {
                    html += `
                        <div class="code-item">
                            <div class="code-info">
                                <div class="code-value">${student.name}</div>
                                <div class="code-student">
                                    <strong>ID: ${student.id}</strong> • Grupo ${student.grupo}
                                    ${student.email ? `• ${student.email}` : ''}
                                    ${student.phone ? `• ${student.phone}` : ''}
                                </div>
                            </div>
                            <div class="code-actions">
                                <button class="btn btn-warning btn-sm" onclick="EduTrack.editStudent(${student.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="EduTrack.deleteStudent(${student.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                countElement.textContent = this.config.students.length;
            },

            editStudent(studentId) {
                const student = this.config.students.find(s => s.id === studentId);
                if (!student) return;

                const newName = prompt('Editar nombre del estudiante:', student.name);
                if (newName === null) return;

                const newEmail = prompt('Editar email (opcional):', student.email || '');
                const newPhone = prompt('Editar teléfono (opcional):', student.phone || '');

                if (newName) {
                    student.name = newName;
                    student.email = newEmail || '';
                    student.phone = newPhone || '';
                    
                    this.saveStudents();
                    this.renderStudentsList();
                    this.loadFamilyStudentSelect();
                    this.showToast('Estudiante actualizado exitosamente', 'success');
                }
            },

            deleteStudent(studentId) {
                const student = this.config.students.find(s => s.id === studentId);
                if (!student) return;

                if (confirm(`¿Estás seguro de que quieres eliminar a ${student.name}? Esta acción no se puede deshacer.`)) {
                    Object.keys(this.data.evaluationData).forEach(key => {
                        if (key.includes(`_${studentId}_`)) {
                            delete this.data.evaluationData[key];
                        }
                    });

                    Object.keys(this.data.familyCodes).forEach(code => {
                        if (this.data.familyCodes[code].studentId === studentId) {
                            delete this.data.familyCodes[code];
                        }
                    });

                    this.config.students = this.config.students.filter(s => s.id !== studentId);
                    
                    this.saveStudents();
                    this.saveEvaluationData();
                    this.saveFamilyCodes();
                    
                    this.renderStudentsList();
                    this.loadFamilyStudentSelect();
                    this.updateAdminStats();
                    this.showToast('Estudiante eliminado exitosamente', 'success');
                }
            },

            loadTeacherSubjects() {
                const select = document.getElementById('teacherSubject');
                select.innerHTML = '<option value="">Selecciona tu materia</option>';
                
                this.config.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = `${subject.name} - ${subject.teacher}`;
                    select.appendChild(option);
                });
            },

            showLoginForm() {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('teacherLogin').classList.add('hidden');
                document.getElementById('parentLogin').classList.add('hidden');

                if (this.data.currentRole === 'admin') {
                    document.getElementById('adminLogin').classList.remove('hidden');
                } else if (this.data.currentRole === 'teacher') {
                    document.getElementById('teacherLogin').classList.remove('hidden');
                } else {
                    document.getElementById('parentLogin').classList.remove('hidden');
                }
            },

            handleAdminLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (username === this.config.admin.username && password === this.config.admin.password) {
                    this.data.currentUser = this.config.admin;
                    this.showToast(`¡Bienvenido ${this.config.admin.name}!`, 'success');
                    
                    setTimeout(() => {
                        this.showScreen('adminScreen');
                        document.getElementById('userAvatar').textContent = 'PA';
                        document.getElementById('adminName').textContent = this.config.admin.name;
                        this.updateAdminStats();
                        this.renderTeachersList();
                        this.loadFamilyStudentSelect();
                        this.renderStudentsList();
                    }, 1000);
                } else {
                    this.showToast('Credenciales incorrectas', 'error');
                }
            },

            teacherLogin() {
                const subjectId = document.getElementById('teacherSubject').value;
                const password = document.getElementById('teacherPassword').value;
                
                if (!subjectId) {
                    this.showToast('Selecciona una materia', 'warning');
                    return;
                }

                const subject = this.config.subjects.find(s => s.id === subjectId);
                if (!subject) return;

                if (password === subject.password) {
                    this.data.currentUser = { 
                        name: subject.teacher, 
                        role: 'teacher',
                        subject: subject
                    };
                    this.data.currentSubject = subject;
                    this.showToast(`¡Bienvenido ${subject.teacher}!`, 'success');
                    
                    setTimeout(() => {
                        this.showScreen('teacherScreen');
                        document.getElementById('teacherSubjectName').textContent = `${subject.name} - ${subject.teacher}`;
                        document.getElementById('currentSubjectName').textContent = subject.name;
                        document.getElementById('evaluationSubjectName').textContent = subject.name;
                        document.getElementById('reportsSubjectName').textContent = subject.name;
                        this.updateTeacherStats();
                    }, 1000);
                } else {
                    this.showToast('Contraseña incorrecta para esta materia', 'error');
                }
            },

            parentLogin() {
                const code = document.getElementById('parentCodeInput').value.toUpperCase().trim();
                
                if (!code) {
                    this.showToast('Ingresa el código familiar', 'warning');
                    return;
                }
                
                if (this.data.familyCodes[code] && this.data.familyCodes[code].isActive) {
                    this.data.currentFamilyCode = code;
                    const studentInfo = this.data.familyCodes[code];
                    this.showToast(`Acceso concedido - ${studentInfo.studentName}`, 'success');
                    setTimeout(() => {
                        this.showScreen('parentScreen');
                        document.getElementById('parentStudentName').textContent = `Familia de ${studentInfo.studentName}`;
                        this.loadFamilyData(code);
                    }, 1000);
                } else {
                    this.showToast('Código familiar inválido o inactivo', 'error');
                }
            },

            getStudentEvaluation(subjectId, studentId) {
                const key = this.getEvaluationKey(subjectId, studentId);
                if (!this.data.evaluationData[key]) {
                    this.data.evaluationData[key] = {
                        asistencia: '',
                        trabajo: '',
                        tarea: '',
                        comportamiento: '',
                        observaciones: ''
                    };
                }
                return this.data.evaluationData[key];
            },

            updateStudentEvaluation(subjectId, studentId, type, value) {
                const key = this.getEvaluationKey(subjectId, studentId);
                const data = this.getStudentEvaluation(subjectId, studentId);
                data[type] = value;
                this.saveEvaluationData();
                
                if (this.data.currentSubject) {
                    this.updateTeacherStats();
                }
            },

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');

                if (screenId === 'adminScreen') {
                    this.updateAdminStats();
                    this.showPanel('adminDashboard');
                } else if (screenId === 'teacherScreen') {
                    this.updateTeacherStats();
                    this.showPanel('teacherDashboard');
                } else if (screenId === 'parentScreen') {
                    this.showPanel('parentDashboard');
                }
            },

            showPanel(panelId) {
                const container = document.querySelector('.panel.active')?.closest('.panel')?.parentElement;
                if (container) {
                    container.querySelectorAll('.panel').forEach(panel => {
                        panel.classList.remove('active');
                    });
                    container.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                }
                
                document.getElementById(panelId).classList.add('active');
                document.querySelector(`.nav-btn[data-panel="${panelId}"]`)?.classList.add('active');

                if (panelId === 'evaluationPanel' && this.data.currentSubject) {
                    this.renderTeacherEvaluation();
                } else if (panelId === 'reportsPanel') {
                    if (typeof refrescarReportesHoy === 'function') { refrescarReportesHoy(); }
                } else if (panelId === 'teachersPanel') {
                    this.renderTeachersList();
                } else if (panelId === 'codesPanel') {
                    this.renderFamilyCodes();
                } else if (panelId === 'studentsPanel') {
                    this.renderStudentsList();
                } else if (panelId === 'backupPanel') {
                    EduTrackSync.updateSyncCounters();
                }
            },

            updateAdminStats() {
                const activeCodes = Object.values(this.data.familyCodes).filter(code => code.isActive).length;
                
                document.getElementById('statActiveCodes').textContent = activeCodes;
                document.getElementById('statTotalStudents').textContent = this.config.students.length;
                document.getElementById('statTotalSubjects').textContent = this.config.subjects.length;
                
                const presentDays = Object.values(this.data.evaluationData).filter(eval => 
                    eval.asistencia === 'presente' || eval.asistencia === 'tarde'
                ).length;
                const totalDays = Object.values(this.data.evaluationData).filter(eval => 
                    eval.asistencia !== ''
                ).length || 1;
                
                const overallAttendance = Math.round((presentDays / totalDays) * 100);
                document.getElementById('statOverallAttendance').textContent = overallAttendance + '%';
            },

            updateTeacherStats() {
                if (!this.data.currentSubject) return;

                const subjectId = this.data.currentSubject.id;
                const present = this.config.students.filter(student => {
                    const evaluation = this.getStudentEvaluation(subjectId, student.id);
                    return evaluation.asistencia === 'presente' || evaluation.asistencia === 'tarde';
                }).length;

                document.getElementById('teacherStatTotal').textContent = this.config.students.length;
                document.getElementById('teacherStatPresent').textContent = present;
                document.getElementById('teacherStatAttendance').textContent = 
                    Math.round((present / this.config.students.length) * 100) + '%';
            },

            renderTeacherEvaluation() {
                const container = document.getElementById('teacherEvaluationContainer');
                if (!container || !this.data.currentSubject) return;
                
                container.innerHTML = '';
                const subjectId = this.data.currentSubject.id;
                
                this.config.students.forEach(student => {
                    const evaluation = this.getStudentEvaluation(subjectId, student.id);
                    
                    const card = document.createElement('div');
                    card.className = `student-evaluation-card ${evaluation.asistencia || ''}`;
                    card.innerHTML = `
                        <div class="student-header">
                            <div class="student-name">${student.name}</div>
                            <div class="student-info">
                                <span><i class="fas fa-id-card"></i> ID: ${student.id}</span>
                                <span><i class="fas fa-users"></i> Grupo: ${student.grupo}</span>
                            </div>
                        </div>

                        <div class="evaluation-section">
                            <div class="section-title">
                                <i class="fas fa-user-clock"></i>
                                Asistencia
                            </div>
                            <div class="checkbox-grid">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="asistencia-presente-${student.id}" 
                                           name="asistencia-${student.id}" value="presente"
                                           ${evaluation.asistencia === 'presente' ? 'checked' : ''}>
                                    <label for="asistencia-presente-${student.id}" class="status-presente">
                                        <i class="fas fa-check"></i> Presente
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="asistencia-tarde-${student.id}" 
                                           name="asistencia-${student.id}" value="tarde"
                                           ${evaluation.asistencia === 'tarde' ? 'checked' : ''}>
                                    <label for="asistencia-tarde-${student.id}" class="status-tarde">
                                        <i class="fas fa-clock"></i> Tarde
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="asistencia-falta-${student.id}" 
                                           name="asistencia-${student.id}" value="falta"
                                           ${evaluation.asistencia === 'falta' ? 'checked' : ''}>
                                    <label for="asistencia-falta-${student.id}" class="status-falta">
                                        <i class="fas fa-times"></i> Falta
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="evaluation-section">
                            <div class="section-title">
                                <i class="fas fa-tasks"></i>
                                Trabajo
                            </div>
                            <div class="checkbox-grid">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="trabajo-alto-${student.id}" 
                                           name="trabajo-${student.id}" value="alto"
                                           ${evaluation.trabajo === 'alto' ? 'checked' : ''}>
                                    <label for="trabajo-alto-${student.id}" class="status-alto">
                                        <i class="fas fa-arrow-up"></i> Alto
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="trabajo-medio-${student.id}" 
                                           name="trabajo-${student.id}" value="medio"
                                           ${evaluation.trabajo === 'medio' ? 'checked' : ''}>
                                    <label for="trabajo-medio-${student.id}" class="status-medio">
                                        <i class="fas fa-minus"></i> Medio
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="trabajo-bajo-${student.id}" 
                                           name="trabajo-${student.id}" value="bajo"
                                           ${evaluation.trabajo === 'bajo' ? 'checked' : ''}>
                                    <label for="trabajo-bajo-${student.id}" class="status-bajo">
                                        <i class="fas fa-arrow-down"></i> Bajo
                                    </label>
                                </div>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <div class="checkbox-grid">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tarea-si-${student.id}" 
                                               name="tarea-${student.id}" value="si"
                                               ${evaluation.tarea === 'si' ? 'checked' : ''}>
                                        <label for="tarea-si-${student.id}" class="status-bien">
                                            <i class="fas fa-check-circle"></i> Tarea: Sí
                                        </label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tarea-no-${student.id}" 
                                               name="tarea-${student.id}" value="no"
                                               ${evaluation.tarea === 'no' ? 'checked' : ''}>
                                        <label for="tarea-no-${student.id}" class="status-falta">
                                            <i class="fas fa-times-circle"></i> Tarea: No
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="evaluation-section">
                            <div class="section-title">
                                <i class="fas fa-brain"></i>
                                Comportamiento
                            </div>
                            <div class="checkbox-grid">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="comportamiento-bien-${student.id}" 
                                           name="comportamiento-${student.id}" value="bien"
                                           ${evaluation.comportamiento === 'bien' ? 'checked' : ''}>
                                    <label for="comportamiento-bien-${student.id}" class="status-bien">
                                        <i class="fas fa-smile"></i> Bien
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="comportamiento-regular-${student.id}" 
                                           name="comportamiento-${student.id}" value="regular"
                                           ${evaluation.comportamiento === 'regular' ? 'checked' : ''}>
                                    <label for="comportamiento-regular-${student.id}" class="status-regular">
                                        <i class="fas fa-meh"></i> Regular
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="comportamiento-deficiente-${student.id}" 
                                           name="comportamiento-${student.id}" value="deficiente"
                                           ${evaluation.comportamiento === 'deficiente' ? 'checked' : ''}>
                                    <label for="comportamiento-deficiente-${student.id}" class="status-deficiente">
                                        <i class="fas fa-frown"></i> Deficiente
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="evaluation-section notes-section">
                            <div class="section-title">
                                <i class="fas fa-edit"></i>
                                Observaciones
                            </div>
                            <textarea class="notes-textarea" id="observaciones-${student.id}" 
                                      placeholder="Escribe aquí observaciones adicionales..."
                                      oninput="EduTrack.guardarEvaluacionIndividual(${student.id})">${evaluation.observaciones || ''}</textarea>
                        </div>

                        <div class="student-actions">
                            <button class="btn btn-primary btn-sm" onclick="EduTrack.guardarEvaluacionIndividual(${student.id})">
                                <i class="fas fa-save"></i>
                                Guardar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="EduTrack.limpiarEvaluacionIndividual(${student.id})">
                                <i class="fas fa-undo"></i>
                                Limpiar
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });

                this.configurarCheckboxesEvaluacion();
            },

            configurarCheckboxesEvaluacion() {
                document.querySelectorAll('#teacherEvaluationContainer input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const name = this.name;
                        const studentId = this.id.split('-').pop();
                        
                        if (this.checked) {
                            document.querySelectorAll(`#teacherEvaluationContainer input[name="${name}"]`).forEach(otherCheckbox => {
                                if (otherCheckbox !== this && otherCheckbox.checked) {
                                    otherCheckbox.checked = false;
                                }
                            });
                            
                            if (name.startsWith('asistencia-')) {
                                const card = this.closest('.student-evaluation-card');
                                card.className = `student-evaluation-card ${this.value}`;
                            }

                            EduTrack.guardarEvaluacionIndividual(parseInt(studentId));
                        }
                    });
                });
            },

            guardarEvaluacionIndividual(studentId) {
                if (!this.data.currentSubject) return;

                const card = document.querySelector(`#teacherEvaluationContainer .student-evaluation-card [id$="-${studentId}"]`)?.closest('.student-evaluation-card');
                if (!card) return;

                const subjectId = this.data.currentSubject.id;
                
                const asistencia = card.querySelector('input[name^="asistencia-"]:checked')?.value || '';
                const trabajo = card.querySelector('input[name^="trabajo-"]:checked')?.value || '';
                const tarea = card.querySelector('input[name^="tarea-"]:checked')?.value || '';
                const comportamiento = card.querySelector('input[name^="comportamiento-"]:checked')?.value || '';
                const observaciones = card.querySelector(`#observaciones-${studentId}`).value;

                const key = this.getEvaluationKey(subjectId, studentId);
                this.data.evaluationData[key] = {
                    asistencia,
                    trabajo,
                    tarea,
                    comportamiento,
                    observaciones,
                    fecha: new Date().toISOString()
                };

                this.saveEvaluationData();
                this.updateTeacherStats();
                
                this.showToast(`${this.config.students.find(e => e.id === studentId).name} guardado`, 'success');
            },

            limpiarEvaluacionIndividual(studentId) {
                if (!this.data.currentSubject) return;

                if (confirm('¿Estás seguro de que quieres limpiar la evaluación de este estudiante?')) {
                    const subjectId = this.data.currentSubject.id;
                    const key = this.getEvaluationKey(subjectId, studentId);
                    delete this.data.evaluationData[key];
                    
                    this.saveEvaluationData();
                    this.renderTeacherEvaluation();
                    this.updateTeacherStats();
                    this.showToast('Evaluación limpiada', 'success');
                }
            },

            guardarTodasEvaluaciones() {
                if (!this.data.currentSubject) return;

                let guardados = 0;
                this.config.students.forEach(student => {
                    this.guardarEvaluacionIndividual(student.id);
                    guardados++;
                });
                
                this.showToast(`${guardados} evaluaciones guardadas`, 'success');
            },

            limpiarTodasEvaluaciones() {
                if (!this.data.currentSubject) return;

                if (confirm('¿Estás seguro de que quieres limpiar TODAS las evaluaciones de esta materia? Esta acción no se puede deshacer.')) {
                    const subjectId = this.data.currentSubject.id;
                    
                    Object.keys(this.data.evaluationData).forEach(key => {
                        if (key.startsWith(subjectId + '_')) {
                            delete this.data.evaluationData[key];
                        }
                    });
                    
                    this.saveEvaluationData();
                    this.renderTeacherEvaluation();
                    this.updateTeacherStats();
                    this.showToast('Todas las evaluaciones han sido limpiadas', 'success');
                }
            },

            renderTeachersList() {
                const container = document.getElementById('teachersList');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.config.subjects.forEach(subject => {
                    const subjectItem = document.createElement('div');
                    subjectItem.className = 'code-item';
                    subjectItem.innerHTML = `
                        <div class="code-info">
                            <div class="code-value">${subject.name}</div>
                            <div class="code-student">
                                <strong>Maestro:</strong> ${subject.teacher}
                            </div>
                            <div style="color: var(--muted); font-size: 0.8rem;">
                                Contraseña: ${subject.password} | ID: ${subject.id}
                            </div>
                        </div>
                        <div class="code-actions">
                            <button class="btn btn-primary" onclick="EduTrack.editTeacher('${subject.id}')">
                                <i class="fas fa-edit"></i>
                                Editar
                            </button>
                            <button class="btn btn-secondary" onclick="EduTrack.copySubjectPassword('${subject.password}')">
                                <i class="fas fa-copy"></i>
                                Copiar
                            </button>
                        </div>
                    `;
                    container.appendChild(subjectItem);
                });
            },

            editTeacher(subjectId) {
                const subject = this.config.subjects.find(s => s.id === subjectId);
                if (!subject) return;

                const newTeacher = prompt(`Editar maestro para ${subject.name}:`, subject.teacher || '');
                if (newTeacher !== null) {
                    subject.teacher = newTeacher;
                    this.showToast(`Maestro actualizado para ${subject.name}`, 'success');
                    this.renderTeachersList();
                }
            },

            copySubjectPassword(password) {
                navigator.clipboard.writeText(password).then(() => {
                    this.showToast('Contraseña copiada al portapapeles', 'success');
                });
            },

            loadFamilyStudentSelect() {
                const select = document.getElementById('familyStudentSelect');
                select.innerHTML = '<option value="">Selecciona un estudiante</option>';
                
                this.config.students.forEach(student => {
                    const hasCode = Object.values(this.data.familyCodes).some(code => 
                        code.studentId === student.id && code.isActive
                    );
                    
                    if (!hasCode) {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.name} (Grupo ${student.grupo})`;
                        select.appendChild(option);
                    }
                });

                if (select.options.length === 1) {
                    select.innerHTML = '<option value="">Todos los estudiantes ya tienen código familiar</option>';
                }
            },

            generateFamilyCode() {
                const studentId = document.getElementById('familyStudentSelect').value;
                
                if (!studentId) {
                    this.showToast('Selecciona un estudiante primero', 'warning');
                    return;
                }

                const student = this.config.students.find(s => s.id == studentId);
                if (!student) return;

                let code;
                do {
                    code = Math.random().toString(36).substring(2, 8).toUpperCase();
                } while (this.data.familyCodes[code]);

                this.data.familyCodes[code] = {
                    studentId: student.id,
                    studentName: student.name,
                    group: student.grupo,
                    generatedAt: new Date(),
                    expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                    isActive: true
                };

                this.saveFamilyCodes();
                this.showFamilyCodeGeneratedModal(code, student.name);
                this.loadFamilyStudentSelect();
                this.renderFamilyCodes();
                this.updateAdminStats();
            },

            showFamilyCodeGeneratedModal(code, studentName) {
                const modalHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 3rem; color: var(--success); margin-bottom: 15px;">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 style="color: var(--success); margin-bottom: 10px;">¡Código Familiar Generado!</h3>
                        <p style="color: var(--muted); margin-bottom: 15px;">
                            Código para la familia de: <strong>${studentName}</strong>
                        </p>
                        <div style="font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: 3px; margin: 20px 0; padding: 15px; background: rgba(0,0,0,.3); border-radius: var(--radius);">
                            ${code}
                        </div>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 20px;">
                            Este código da acceso a TODAS las materias del estudiante
                        </p>
                        <button class="btn btn-success" onclick="EduTrack.shareFamilyCode('${code}', '${studentName}')" style="margin-bottom: 10px;">
                            <i class="fab fa-whatsapp"></i>
                            Compartir por WhatsApp
                        </button>
                        <br>
                        <button class="btn btn-secondary" onclick="EduTrack.closeModal()">
                            <i class="fas fa-times"></i>
                            Cerrar
                        </button>
                    </div>
                `;
                
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.background = 'rgba(0,0,0,0.8)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                modal.innerHTML = `
                    <div style="background: var(--card); padding: 30px; border-radius: var(--radius); max-width: 400px; width: 90%;">
                        ${modalHTML}
                    </div>
                `;
                
                document.body.appendChild(modal);
            },

            closeModal() {
                const modal = document.querySelector('div[style*="position: fixed;"]');
                if (modal) {
                    modal.remove();
                }
            },

            shareFamilyCode(code, studentName) {
                const message = `¡Hola! Tu código familiar para acceder al progreso de ${studentName} en EduTrack es: ${code}\n\nEste código te permite ver el progreso en TODAS las materias. Ingresa al sistema y úsalo para ver el progreso integral de tu hijo.`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            },

            renderFamilyCodes() {
                const container = document.getElementById('familyCodesList');
                container.innerHTML = '';

                const activeCodes = Object.entries(this.data.familyCodes).filter(([code, data]) => data.isActive);

                if (activeCodes.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--muted);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>No hay códigos familiares activos</p>
                        </div>
                    `;
                    return;
                }

                activeCodes.forEach(([code, data]) => {
                    const codeItem = document.createElement('div');
                    codeItem.className = 'code-item';
                    codeItem.innerHTML = `
                        <div class="code-info">
                            <div class="code-value">${code}</div>
                            <div class="code-student">${data.studentName} - Grupo ${data.group}</div>
                            <div style="color: var(--muted); font-size: 0.8rem;">
                                Generado: ${new Date(data.generatedAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="code-actions">
                            <button class="btn btn-danger" onclick="EduTrack.deactivateFamilyCode('${code}')" title="Desactivar código">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button class="btn btn-primary" onclick="EduTrack.showFamilyCodeGeneratedModal('${code}', '${data.studentName}')" title="Ver código">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(codeItem);
                });
            },

            deactivateFamilyCode(code) {
                if (confirm('¿Estás seguro de que quieres desactivar este código familiar?')) {
                    this.data.familyCodes[code].isActive = false;
                    this.saveFamilyCodes();
                    this.renderFamilyCodes();
                    this.updateAdminStats();
                    this.showToast('Código familiar desactivado', 'warning');
                }
            },

            loadFamilyData(code) {
                const familyInfo = this.data.familyCodes[code];
                if (!familyInfo) return;

                const studentId = familyInfo.studentId;
                let html = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">👨‍🎓</div>
                        <h3 style="color: var(--text); margin-bottom: 8px;">${familyInfo.studentName}</h3>
                        <p style="color: var(--muted);">Grupo ${familyInfo.group}</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">
                            <i class="fas fa-chart-line"></i>
                            Progreso General
                        </h4>
                `;

                this.config.subjects.forEach(subject => {
                    const evaluation = this.getStudentEvaluation(subject.id, studentId);
                    
                    const attendanceDays = Object.keys(this.data.evaluationData).filter(key => 
                        key.startsWith(`${subject.id}_${studentId}_`) && 
                        (this.data.evaluationData[key].asistencia === 'presente' || this.data.evaluationData[key].asistencia === 'tarde')
                    ).length;
                    const totalDays = Object.keys(this.data.evaluationData).filter(key => 
                        key.startsWith(`${subject.id}_${studentId}_`)
                    ).length || 1;
                    const attendancePercent = Math.round((attendanceDays / totalDays) * 100);

                    html += `
                        <div style="background: rgba(255,255,255,.05); padding: 15px; border-radius: var(--radius); margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${subject.name}</strong>
                                    <div style="font-size: 0.8rem; color: var(--muted);">
                                        ${subject.teacher}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: var(--success);">
                                        ${attendancePercent}%
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--muted);">
                                        asistencia
                                    </div>
                                </div>
                            </div>
                            ${evaluation.observaciones ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,.1);">
                                    <div style="font-size: 0.85rem; color: var(--muted);">
                                        <strong>Observaciones:</strong> ${evaluation.observaciones}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += `</div>`;

                document.getElementById('familyProgress').innerHTML = html;
            },

            updateDateDisplay() {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateStr = this.data.currentDate.toLocaleDateString('es-ES', options);
                const dateElement = document.getElementById('currentDateDisplay');
                if (dateElement) {
                    dateElement.textContent = dateStr;
                }
            },

            showToast(message, type) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
            },

            logout() {
                this.showScreen('loginScreen');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('parentCodeInput').value = '';
                document.getElementById('teacherPassword').value = '';
                this.data.currentUser = null;
                this.data.currentSubject = null;
                this.data.currentFamilyCode = null;
                
                this.data.currentRole = 'admin';
                this.showLoginForm();
                document.querySelectorAll('.role-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('.role-btn[data-role="admin"]').classList.add('active');
            }
        };

        // SISTEMA DE SINCRONIZACIÓN MEJORADO
        const EduTrackSync = {
            isOnline: true,
            pendingActions: [],

            init() {
                this.setupOnlineListener();
                this.loadPendingActions();
                setInterval(() => this.processPendingActions(), 30000);
                console.log("✓ EduTrackSync inicializado");
            },

            setupOnlineListener() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateSyncStatus();
                    this.processPendingActions();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateSyncStatus();
                });

                this.updateSyncStatus();
            },

            updateSyncStatus() {
                const status = document.getElementById('syncStatus');
                const offline = document.getElementById('offlineIndicator');
                
                if (this.isOnline) {
                    status.className = 'sync-status connected';
                    status.innerHTML = '<i class="fas fa-cloud"></i><span>Conectado</span>';
                    offline.style.display = 'none';
                } else {
                    status.className = 'sync-status disconnected';
                    status.innerHTML = '<i class="fas fa-cloud-slash"></i><span>Sin conexión</span>';
                    offline.style.display = 'block';
                }
            },

            async syncToFirestore(key, data) {
                if (!this.isOnline || !window.db) {
                    this.queueAction('sync', { key, data });
                    return false;
                }

                try {
                    document.body.classList.add('loading');
                    await window.db.collection("edutrack_data").doc(key).set({
                        value: JSON.stringify(data),
                        updated: firebase.firestore.FieldValue.serverTimestamp(),
                        timestamp: new Date().toISOString()
                    });
                    
                    EduTrack.showToast(`Datos de ${key} sincronizados`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error sync:', error);
                    this.queueAction('sync', { key, data });
                    EduTrack.showToast('Error de sincronización', 'error');
                    return false;
                } finally {
                    document.body.classList.remove('loading');
                }
            },

            async syncFromFirestore() {
                if (!window.db) {
                    EduTrack.showToast('Firebase no disponible', 'error');
                    return;
                }

                try {
                    document.body.classList.add('loading');
                    const snapshot = await window.db.collection("edutrack_data").get();
                    let updated = 0;

                    snapshot.forEach(doc => {
                        try {
                            const data = JSON.parse(doc.data().value);
                            switch(doc.id) {
                                case 'edutrack_students':
                                    EduTrack.config.students = data;
                                    localStorage.setItem('edutrack_students', JSON.stringify(data));
                                    updated++;
                                    break;
                                case 'edutrack_family_codes':
                                    EduTrack.data.familyCodes = data;
                                    localStorage.setItem('edutrack_family_codes', JSON.stringify(data));
                                    updated++;
                                    break;
                                case 'edutrack_evaluation_data':
                                    EduTrack.data.evaluationData = data;
                                    localStorage.setItem('edutrack_evaluation_data', JSON.stringify(data));
                                    updated++;
                                    break;
                            }
                        } catch (e) {
                            console.warn('Error parsing:', doc.id, e);
                        }
                    });

                    this.updateSyncCounters();
                    EduTrack.showToast(`${updated} conjuntos de datos actualizados`, 'success');
                    
                    EduTrack.renderStudentsList();
                    EduTrack.renderFamilyCodes();
                    EduTrack.updateAdminStats();
                    
                } catch (error) {
                    console.error('Error loading from Firestore:', error);
                    EduTrack.showToast('Error cargando datos', 'error');
                } finally {
                    document.body.classList.remove('loading');
                }
            },

            updateSyncCounters() {
                document.getElementById('syncStudents').textContent = EduTrack.config.students.length;
                document.getElementById('syncEvaluations').textContent = Object.keys(EduTrack.data.evaluationData).length;
                document.getElementById('syncCodes').textContent = Object.keys(EduTrack.data.familyCodes).length;
            },

            queueAction(type, data) {
                this.pendingActions.push({ type, data, timestamp: new Date() });
                localStorage.setItem('edutrack_pending_actions', JSON.stringify(this.pendingActions));
            },

            loadPendingActions() {
                try {
                    const actions = localStorage.getItem('edutrack_pending_actions');
                    this.pendingActions = actions ? JSON.parse(actions) : [];
                } catch (e) {
                    this.pendingActions = [];
                }
            },

            async processPendingActions() {
                if (!this.isOnline || this.pendingActions.length === 0) return;

                for (let i = this.pendingActions.length - 1; i >= 0; i--) {
                    const action = this.pendingActions[i];
                    try {
                        if (action.type === 'sync') {
                            await this.syncToFirestore(action.data.key, action.data.data);
                            this.pendingActions.splice(i, 1);
                        }
                    } catch (error) {
                        console.error('Error processing pending action:', error);
                    }
                }
                
                localStorage.setItem('edutrack_pending_actions', JSON.stringify(this.pendingActions));
            },

            exportData() {
                const data = {
                    students: EduTrack.config.students,
                    familyCodes: EduTrack.data.familyCodes,
                    evaluationData: EduTrack.data.evaluationData,
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };

                this.downloadJSON(data, `edutrack-backup-${new Date().toISOString().split('T')[0]}.json`);
                EduTrack.showToast('Datos exportados exitosamente', 'success');
            },

            exportStudents() {
                const data = {
                    students: EduTrack.config.students,
                    exportDate: new Date().toISOString()
                };

                this.downloadJSON(data, `edutrack-students-${new Date().toISOString().split('T')[0]}.json`);
                EduTrack.showToast('Estudiantes exportados', 'success');
            },

            importData() {
                const fileInput = document.getElementById('backupFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    EduTrack.showToast('Selecciona un archivo', 'warning');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (confirm('¿Estás seguro de que quieres importar estos datos? Esto sobrescribirá los datos actuales.')) {
                            if (data.students) {
                                EduTrack.config.students = data.students;
                                localStorage.setItem('edutrack_students', JSON.stringify(data.students));
                                this.syncToFirestore('edutrack_students', data.students);
                            }
                            
                            if (data.familyCodes) {
                                EduTrack.data.familyCodes = data.familyCodes;
                                localStorage.setItem('edutrack_family_codes', JSON.stringify(data.familyCodes));
                                this.syncToFirestore('edutrack_family_codes', data.familyCodes);
                            }
                            
                            if (data.evaluationData) {
                                EduTrack.data.evaluationData = data.evaluationData;
                                localStorage.setItem('edutrack_evaluation_data', JSON.stringify(data.evaluationData));
                                this.syncToFirestore('edutrack_evaluation_data', data.evaluationData);
                            }

                            EduTrack.showToast('Datos importados exitosamente', 'success');
                            setTimeout(() => location.reload(), 1000);
                        }
                    } catch (error) {
                        EduTrack.showToast('Error importando datos: archivo inválido', 'error');
                    }
                };
                reader.readAsText(file);
            },

            downloadJSON(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        // ⭐ SISTEMA DE CARGA MEJORADO
        window.appLoaded = false;

        function checkAppReady() {
            if (typeof EduTrack !== 'undefined') {
                if (!window.appLoaded) {
                    window.appLoaded = true;
                    console.log("✓ App completamente cargada y lista");
                    
                    // Asegurar que la pantalla de login sea visible
                    const activeScreen = document.querySelector('.screen.active');
                    if (!activeScreen || activeScreen.id !== 'loginScreen') {
                        setTimeout(() => {
                            if (typeof EduTrack !== 'undefined') {
                                EduTrack.showScreen('loginScreen');
                            }
                        }, 100);
                    }
                }
            } else {
                setTimeout(checkAppReady, 300);
            }
        }

        // Inicialización mejorada
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM cargado - Iniciando EduTrack...");
            
            // Inicializar componentes principales
            try {
                EduTrack.init();
                EduTrackSync.init();
                
                // Configurar sync automático
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = function(key, value) {
                    originalSetItem.call(this, key, value);
                    
                    if (key === 'edutrack_students') {
                        EduTrackSync.syncToFirestore(key, JSON.parse(value));
                    } else if (key === 'edutrack_family_codes') {
                        EduTrackSync.syncToFirestore(key, JSON.parse(value));
                    } else if (key === 'edutrack_evaluation_data') {
                        EduTrackSync.syncToFirestore(key, JSON.parse(value));
                    }
                };
                
                // Verificar estado de la app
                setTimeout(checkAppReady, 500);
                setTimeout(checkAppReady, 1000);
                
            } catch (error) {
                console.error("Error inicializando app:", error);
                // Forzar que al menos el login sea visible
                setTimeout(() => {
                    document.getElementById('loginScreen').classList.add('active');
                }, 100);
            }
        });

        // Verificación final cuando todo carga
        window.addEventListener('load', function() {
            console.log("Página completamente cargada");
            setTimeout(checkAppReady, 300);
            
            // Último recurso: después de 3 segundos, forzar que la app esté usable
            setTimeout(() => {
                if (!window.appLoaded) {
                    console.log("Forzando carga de app...");
                    window.appLoaded = true;
                    document.getElementById('loginScreen').classList.add('active');
                }
            }, 3000);
        });

        // Funciones globales
        function showScreen(screenId) { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.showScreen(screenId); 
            }
        }
        function showPanel(panelId) { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.showPanel(panelId); 
            }
        }
        function logout() { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.logout(); 
            }
        }
        function parentLogin() { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.parentLogin(); 
            }
        }
        function teacherLogin() { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.teacherLogin(); 
            }
        }
        function generateFamilyCode() { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.generateFamilyCode(); 
            }
        }
        function generateReports() { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.showPanel('reportsPanel'); 
            }
        }
        function guardarTodasEvaluaciones() { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.guardarTodasEvaluaciones(); 
            }
        }
        function limpiarTodasEvaluaciones() { 
            if (typeof EduTrack !== 'undefined') {
                EduTrack.limpiarTodasEvaluaciones(); 
            }
        }
    </script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
    
    <script>
        // ⭐ FIREBASE MEJORADO CON MANEJO DE ERRORES
        (function(){
            const firebaseConfig = {
                apiKey: "AIzaSyCH-8mjFCHNktcNCqYK8VR_RAYI3Bswyzs",
                authDomain: "edutrack-989cb.firebaseapp.com",
                projectId: "edutrack-989cb",
                storageBucket: "edutrack-989cb.appspot.com",
                messagingSenderId: "555664399684",
                appId: "1:555664399684:web:1ef592148835fd27410b11"
            };
            
            let firebaseInitialized = false;

            function initializeFirebase() {
                try {
                    console.log("🔄 Inicializando Firebase...");
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    window.db = firebase.firestore();
                    
                    // Timeout para no bloquear la app
                    const initTimeout = setTimeout(() => {
                        if (!firebaseInitialized) {
                            console.log("⚠️ Firebase timeout - continuando en modo offline");
                            handleFirebaseReady();
                        }
                    }, 4000);

                    // Intentar persistencia pero continuar si falla
                    window.db.enablePersistence()
                        .then(() => {
                            clearTimeout(initTimeout);
                            handleFirebaseReady();
                        })
                        .catch(err => {
                            clearTimeout(initTimeout);
                            console.log("ℹ️ Persistencia no disponible:", err);
                            handleFirebaseReady();
                        });
                        
                } catch (error) {
                    console.error("❌ Error inicializando Firebase:", error);
                    handleFirebaseReady(); // Continuar aunque falle
                }
            }

            function handleFirebaseReady() {
                firebaseInitialized = true;
                console.log("✅ Firebase listo");
                
                if (typeof EduTrackSync !== 'undefined') {
                    EduTrackSync.isOnline = true;
                    EduTrackSync.updateSyncStatus();
                }
                
                // Intentar sincronización inicial
                setTimeout(() => {
                    if (typeof EduTrackSync !== 'undefined' && EduTrackSync.isOnline) {
                        EduTrackSync.syncFromFirestore().catch(e => {
                            console.log("Sync inicial falló, continuando...");
                        });
                    }
                }, 2000);
            }

            // Inicializar Firebase cuando el DOM esté listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeFirebase);
            } else {
                initializeFirebase();
            }

        })();
    </script>

    <footer style="position:fixed;right:14px;bottom:10px;font:12px/1.2 system-ui;color:#9ca3af;z-index:9999">
        By <b style="color:#22c55e">CactusTech</b> v2.1
    </footer>
</body>
</html>